# Preprocessing notebooks

This directory contains the **documented preprocessing notebooks** used to
construct the training datasets and taxonomy tree artifacts for the
OTU+Taxa foundation model.

These notebooks are **not exploratory drafts**.  
Each notebook corresponds to a well-defined transformation step whose outputs
are saved to disk and reused by the training pipeline.

The intent of this folder is:
- reproducibility of dataset construction,
- traceability of design decisions,
- and long-term maintainability of the preprocessing logic.

---

## Notebooks


### `01_build_training_dataset.ipynb`

Construction of the **training dataset** used by the OTU+Taxa foundation model.

This notebook:
- selects OTUs based on global abundance (e.g. top 99.9%),
- resolves OTU → taxonomy mappings using contiguous valid taxonomy paths,
- builds:
  - `otu_vocab.json`
  - `taxonomy_vocab.json` (ALL nodes in the induced tree)
  - `samples.jsonl` (OTU + taxonomy indices per sample),
- enforces a strict and reproducible indexing contract across all outputs.

The resulting dataset is large and heavy, so it is stored outside this
repository (e.g. in Microbeatlas_preprocess_training/).
This repository only contains the code and documentation needed to
reproduce the preprocessing and to load the generated artifacts during training.

---

### `02_LCA_matrix_from_tree.ipynb`

Construction of **tree-structured artifacts** derived from the taxonomy hierarchy.

This notebook:
- rebuilds the full taxonomy tree from `taxonomy_nested.json`,
- computes lowest-common-ancestor (LCA) edge distances between taxonomy nodes,
- saves topology-only distance matrices aligned with `taxonomy_vocab.json`.

These artifacts are used for:
- hierarchical regularization,
- distance-based penalties,
- and analysis of taxonomy-aware embeddings.


---

### `03_decendant_matrix_builder.ipynb`

Construction of **descendant-closure matrices** for the taxonomy tree.

This notebook:
- computes the ancestor/descendant closure matrix `M`,
- validates tree completeness and vocabulary alignment,
- provides utilities to inspect descendants of arbitrary taxonomy nodes.

An extended version of the descendant matrix is also generated by:
- appending one UNK token per rank (`k:UNK` … `s:UNK`),
- enforcing valid hierarchical transitions when taxonomy labels are missing.

These matrices are used to:
- constrain per-rank predictions,
- enforce hierarchical consistency,
- support UNK-aware decoding in the model.

---

## Notes

- All notebooks assume **index alignment** across:
  `taxonomy_vocab.json`, tree artifacts, and model tensors.
- Preprocessing outputs are intentionally saved **outside the code repository**
  to keep the repo lightweight.

---


